paths:
  /v3/apps/{guid}/manifest:
    get:
      summary: Get app manifest
      description: |
        Generate a manifest for an app and its underlying processes.
        The manifest is a representation of the current state of the app.
      parameters:
        - name: guid
          in: path
          required: true
          description: The app GUID
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/x-yaml:
              schema:
                type: string
                example: |
                  ---
                  applications:
                  - name: my-app
                    memory: 512M
                    instances: 2
                    disk_quota: 1024M
                    health-check-type: http
                    health-check-http-endpoint: /health
                    timeout: 60
                    env:
                      VAR1: value1
                      VAR2: value2
                    routes:
                    - route: my-app.example.com
                    - route: my-app.example.com/path
                    services:
                    - my-database
                    - my-cache
                    stack: cflinuxfs3
                    buildpacks:
                    - ruby_buildpack
                    - https://github.com/cloudfoundry/staticfile-buildpack
                    metadata:
                      labels:
                        contact: team@example.com
                      annotations:
                        version: 1.2.3
        '404':
          description: Not Found
      security:
        - bearerAuth: []

  /v3/spaces/{guid}/actions/apply_manifest:
    post:
      summary: Apply manifest to a space
      description: |
        Apply a manifest to a space. This will create/update apps, 
        routes, and services as specified in the manifest.
        This operation is asynchronous and returns a job.
      parameters:
        - name: guid
          in: path
          required: true
          description: The space GUID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/x-yaml:
            schema:
              type: string
              example: |
                ---
                applications:
                - name: my-app
                  memory: 512M
                  instances: 2
      responses:
        '202':
          description: Accepted
          headers:
            Location:
              description: Location of the job
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  guid:
                    type: string
                    format: uuid
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  operation:
                    type: string
                    example: "apps.apply_manifest"
                  state:
                    type: string
                    enum: [PROCESSING, COMPLETE, FAILED]
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: integer
                        title:
                          type: string
                        detail:
                          type: string
                  warnings:
                    type: array
                    items:
                      type: object
                      properties:
                        detail:
                          type: string
                  links:
                    type: object
                    properties:
                      self:
                        type: object
                        properties:
                          href:
                            type: string
                      space:
                        type: object
                        properties:
                          href:
                            type: string
        '422':
          description: Unprocessable Entity - Invalid manifest
      security:
        - bearerAuth: []

  /v3/spaces/{guid}/manifest_diff:
    post:
      summary: Generate manifest diff
      description: |
        Compare a manifest with the current state of a space.
        Returns the differences that would be applied.
        This is an experimental feature.
      x-experimental: true
      parameters:
        - name: guid
          in: path
          required: true
          description: The space GUID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/x-yaml:
            schema:
              type: string
              example: |
                ---
                applications:
                - name: my-app
                  memory: 1024M
                  instances: 3
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  diff:
                    type: array
                    items:
                      type: object
                      properties:
                        op:
                          type: string
                          enum: [add, remove, replace]
                          description: The operation to be performed
                        path:
                          type: string
                          description: The path to the property being changed
                        was:
                          description: The previous value (for replace operations)
                        value:
                          description: The new value
                example:
                  diff:
                    - op: replace
                      path: /applications/0/memory
                      was: 512M
                      value: 1024M
                    - op: replace
                      path: /applications/0/instances
                      was: 2
                      value: 3
        '422':
          description: Unprocessable Entity - Invalid manifest
      security:
        - bearerAuth: []

components:
  schemas:
    ManifestApp:
      type: object
      properties:
        name:
          type: string
          description: The application name
        memory:
          type: string
          description: Memory limit (e.g. 256M, 1G)
        instances:
          type: integer
          description: Number of instances
        disk_quota:
          type: string
          description: Disk quota (e.g. 512M, 1G)
        health-check-type:
          type: string
          enum: [port, process, http]
        health-check-http-endpoint:
          type: string
          description: HTTP endpoint for health checks
        timeout:
          type: integer
          description: Health check timeout in seconds
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
        routes:
          type: array
          items:
            type: object
            properties:
              route:
                type: string
        services:
          type: array
          items:
            type: string
          description: Service instance names to bind
        stack:
          type: string
          description: Stack name
        buildpacks:
          type: array
          items:
            type: string
          description: Buildpack names or URLs
        command:
          type: string
          description: Custom start command
        random-route:
          type: boolean
          description: Generate a random route
        no-route:
          type: boolean
          description: Do not create any routes
        processes:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              instances:
                type: integer
              memory:
                type: string
              disk_quota:
                type: string
              health-check-type:
                type: string
              health-check-http-endpoint:
                type: string
              health-check-invocation-timeout:
                type: integer
              health-check-interval:
                type: integer
              timeout:
                type: integer
              command:
                type: string
        sidecars:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              process_types:
                type: array
                items:
                  type: string
              command:
                type: string
              memory:
                type: string
        metadata:
          type: object
          properties:
            labels:
              type: object
              additionalProperties:
                type: string
            annotations:
              type: object
              additionalProperties:
                type: string

    Manifest:
      type: object
      properties:
        applications:
          type: array
          items:
            $ref: '#/components/schemas/ManifestApp'
        version:
          type: integer
          description: Manifest schema version