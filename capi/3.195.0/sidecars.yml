paths:
  /v3/apps/{guid}/sidecars:
    get:
      summary: List sidecars for an app
      description: |
        Retrieves all sidecars associated with an app.
        
        Sidecars are additional processes that run alongside the main app process, providing
        supporting functionality like proxies, monitoring agents, or log collectors.
      tags:
        - Sidecars
      parameters:
        - name: guid
          in: path
          required: true
          description: The app GUID
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: Number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 5000
            default: 50
        - name: order_by
          in: query
          description: Sort order for results
          schema:
            type: string
            enum: [created_at, -created_at, updated_at, -updated_at, name, -name]
            default: created_at
        - name: names
          in: query
          description: Filter by sidecar names (comma-separated)
          schema:
            type: string
        - name: label_selector
          in: query
          description: Filter by label selector
          schema:
            type: string
        - name: created_ats
          in: query
          description: Filter by creation time
          schema:
            type: string
        - name: updated_ats
          in: query
          description: Filter by update time
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - pagination
                  - resources
                properties:
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  resources:
                    type: array
                    items:
                      $ref: '#/components/schemas/Sidecar'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

    post:
      summary: Create a sidecar for an app
      description: |
        Creates a sidecar associated with an app.
        
        Sidecars are additional processes that run alongside the main app process.
        They share the same lifecycle as the app and are restarted when the app is restarted.
      tags:
        - Sidecars
      parameters:
        - name: guid
          in: path
          required: true
          description: The app GUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
                  $ref: '#/components/schemas/SidecarCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sidecar'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/UnprocessableEntityError'
      security:
        - bearerAuth: []

  /v3/sidecars/{guid}:
    get:
      summary: Get a sidecar
      description: Retrieve detailed information about a specific sidecar.
      tags:
        - Sidecars
      parameters:
        - name: guid
          in: path
          required: true
          description: The sidecar GUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sidecar'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

    patch:
      summary: Update a sidecar
      description: |
        Updates the specified attributes of a sidecar.
        
        Only the provided fields will be updated, all other fields will remain unchanged.
      tags:
        - Sidecars
      parameters:
        - name: guid
          in: path
          required: true
          description: The sidecar GUID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SidecarUpdate'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sidecar'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/UnprocessableEntityError'
      security:
        - bearerAuth: []

    delete:
      summary: Delete a sidecar
      description: |
        Permanently deletes a sidecar.
        
        The sidecar process will be stopped and removed from the app.
      tags:
        - Sidecars
      parameters:
        - name: guid
          in: path
          required: true
          description: The sidecar GUID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: No Content
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

  /v3/processes/{guid}/sidecars:
    get:
      summary: List sidecars for a process
      description: |
        Retrieves all sidecars associated with a specific process type.
        
        This endpoint allows you to see which sidecars are configured to run
        alongside a particular process type (e.g., web, worker).
      tags:
        - Sidecars
        - Processes
      parameters:
        - name: guid
          in: path
          required: true
          description: The process GUID
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: Number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 5000
            default: 50
        - name: order_by
          in: query
          description: Sort order for results
          schema:
            type: string
            enum: [created_at, -created_at, updated_at, -updated_at, name, -name]
            default: created_at
        - name: names
          in: query
          description: Filter by sidecar names (comma-separated)
          schema:
            type: string
        - name: label_selector
          in: query
          description: Filter by label selector
          schema:
            type: string
        - name: created_ats
          in: query
          description: Filter by creation time
          schema:
            type: string
        - name: updated_ats
          in: query
          description: Filter by update time
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - pagination
                  - resources
                properties:
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  resources:
                    type: array
                    items:
                      $ref: '#/components/schemas/Sidecar'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

components:
  schemas:
    Sidecar:
      type: object
      required:
        - guid
        - name
        - command
        - process_types
        - memory_in_mb
        - origin
        - relationships
        - created_at
        - updated_at
        - links
      properties:
        guid:
          type: string
          format: uuid
          description: Unique identifier for the sidecar
        name:
          type: string
          description: Human-readable name for the sidecar
          example: auth-proxy
        command:
          type: string
          description: Command to execute for the sidecar process
          example: bundle exec rackup config.ru -p $PORT
        process_types:
          type: array
          description: Process types this sidecar runs alongside
          items:
            type: string
            example: web
        memory_in_mb:
          type: integer
          description: Memory allocation for the sidecar in MB
          minimum: 1
          example: 256
        origin:
          type: string
          description: How the sidecar was created
          enum: [user, buildpack]
          example: user
        metadata:
          type: object
          description: Additional metadata for the sidecar
          properties:
            labels:
              type: object
              description: Key-value pairs for organizing and filtering
              additionalProperties:
                type: string
              example:
                environment: production
                team: platform
            annotations:
              type: object
              description: Key-value pairs for storing additional information
              additionalProperties:
                type: string
              example:
                contact: platform-team@example.com
                documentation: https://docs.example.com/sidecars
        relationships:
          type: object
          required:
            - app
          properties:
            app:
              type: object
              required:
                - data
              properties:
                data:
                  type: object
                  required:
                    - guid
                  properties:
                    guid:
                      type: string
                      format: uuid
                      description: GUID of the parent app
        created_at:
          type: string
          format: date-time
          description: Timestamp when the sidecar was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the sidecar was last updated
        links:
          type: object
          required:
            - self
            - app
          properties:
            self:
              type: object
              required:
                - href
              properties:
                href:
                  type: string
                  format: uri
                  example: https://api.example.org/v3/sidecars/1cb006ee-fb05-47e1-b541-c34179ddc446
            app:
              type: object
              required:
                - href
              properties:
                href:
                  type: string
                  format: uri
                  example: https://api.example.org/v3/apps/1cb006ee-fb05-47e1-b541-c34179ddc446

    SidecarCreate:
      type: object
      required:
        - name
        - command
        - process_types
      properties:
        name:
          type: string
          description: Human-readable name for the sidecar
          minLength: 1
          maxLength: 255
          example: auth-proxy
        command:
          type: string
          description: Command to execute for the sidecar process
          minLength: 1
          example: bundle exec rackup config.ru -p $PORT
        process_types:
          type: array
          description: Process types this sidecar runs alongside
          minItems: 1
          items:
            type: string
            example: web
        memory_in_mb:
          type: integer
          description: Memory allocation for the sidecar in MB
          minimum: 1
          default: 256
          example: 256
        metadata:
          type: object
          description: Additional metadata for the sidecar
          properties:
            labels:
              type: object
              description: Key-value pairs for organizing and filtering
              additionalProperties:
                type: string
                maxLength: 63
              example:
                environment: production
                team: platform
            annotations:
              type: object
              description: Key-value pairs for storing additional information
              additionalProperties:
                type: string
                maxLength: 5000
              example:
                contact: platform-team@example.com
                documentation: https://docs.example.com/sidecars

    SidecarUpdate:
      type: object
      properties:
        name:
          type: string
          description: Human-readable name for the sidecar
          minLength: 1
          maxLength: 255
          example: auth-proxy
        command:
          type: string
          description: Command to execute for the sidecar process
          minLength: 1
          example: bundle exec rackup config.ru -p $PORT
        process_types:
          type: array
          description: Process types this sidecar runs alongside
          minItems: 1
          items:
            type: string
            example: web
        memory_in_mb:
          type: integer
          description: Memory allocation for the sidecar in MB
          minimum: 1
          example: 256
        metadata:
          type: object
          description: Additional metadata for the sidecar
          properties:
            labels:
              type: object
              description: Key-value pairs for organizing and filtering
              additionalProperties:
                type: string
                maxLength: 63
              example:
                environment: production
                team: platform
            annotations:
              type: object
              description: Key-value pairs for storing additional information
              additionalProperties:
                type: string
                maxLength: 5000
              example:
                contact: platform-team@example.com
                documentation: https://docs.example.com/sidecars

    Pagination:
      type: object
      required:
        - total_results
        - total_pages
        - first
        - last
      properties:
        total_results:
          type: integer
          description: Total number of results across all pages
          minimum: 0
        total_pages:
          type: integer
          description: Total number of pages
          minimum: 0
        first:
          type: object
          required:
            - href
          properties:
            href:
              type: string
              format: uri
              description: URL to the first page of results
        last:
          type: object
          required:
            - href
          properties:
            href:
              type: string
              format: uri
              description: URL to the last page of results
        next:
          type: object
          nullable: true
          properties:
            href:
              type: string
              format: uri
              description: URL to the next page of results
        previous:
          type: object
          nullable: true
          properties:
            href:
              type: string
              format: uri
              description: URL to the previous page of results

  responses:
    BadRequestError:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    UnauthorizedError:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ForbiddenError:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFoundError:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    UnprocessableEntityError:
      description: Unprocessable Entity
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Cloud Foundry UAA token